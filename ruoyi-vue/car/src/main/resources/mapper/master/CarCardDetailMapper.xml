<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.car.mapper.master.CarCardDetailMapper">

    <sql id="selectCarCardDetailVo">
        select id, orderId, cardId, cardName, ticketCode, redeemed, redeemedTime, createTime, redeemedUserId
        from car_card_detail
    </sql>

    <select id="selectByOrderId" resultType="com.ruoyi.car.domain.CarCardDetailEntity">
        <include refid="selectCarCardDetailVo"/>
        where orderId = #{orderId}
        order by id asc
    </select>

    <select id="selectListByTicketCodeLike" resultType="com.ruoyi.car.domain.CarCardDetailEntity">
        <include refid="selectCarCardDetailVo"/>
        <where>
            <if test="ticketCode != null and ticketCode != ''">
                and ticketCode like concat('%', #{ticketCode}, '%')
            </if>
        </where>
        order by id desc
    </select>

    <select id="selectListByTicketCodeLikeVo" resultType="com.ruoyi.car.domain.vo.CarCardDetailVo">
        select d.id, d.orderId, d.cardId, d.cardName, d.ticketCode, d.redeemed, d.redeemedTime, d.createTime, d.redeemedUserId,
               u.nickName as buyerUserName, u.phoneNumber as buyerPhonenumber
        from car_card_detail d
        left join car_order_info o on d.orderId = o.id
        left join car_user u on o.userId = u.id
        <where>
            <if test="ticketCode != null and ticketCode != ''">
                and d.ticketCode like concat('%', #{ticketCode}, '%')
            </if>
        </where>
        order by d.id desc
    </select>

    <select id="selectDetailById" resultType="com.ruoyi.car.domain.vo.CarCardDetailVo">
        select d.id, d.orderId, d.cardId, d.cardName, d.ticketCode, d.redeemed, d.redeemedTime, d.createTime, d.redeemedUserId,
               u.nickName as buyerUserName, u.phoneNumber as buyerPhonenumber
        from car_card_detail d
        left join car_order_info o on d.orderId = o.id
        left join car_user u on o.userId = u.id
        where d.id = #{id}
    </select>

    <update id="updateRedeemedByTicketCode">
        update car_card_detail
        set redeemed = #{redeemed}, redeemedTime = #{redeemedTime}, redeemedUserId = #{redeemedUserId}
        where ticketCode = #{ticketCode}
    </update>
</mapper>
