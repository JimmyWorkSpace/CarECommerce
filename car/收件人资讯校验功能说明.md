# 收件人資訊校驗功能說明

## 功能概述
在確認支付頁面（宅配到府和超商取貨兩種方式）中，為收件人姓名和手機號添加了嚴格的校驗規則，確保數據的準確性和合規性。

## 修改文件
- **前端**：`src/main/resources/templates/payment/index.ftl`
- **後端**：`src/main/java/cc/carce/sale/controller/ECPayController.java`

## 校驗規則

### 1. 手機號校驗
手機號必須符合以下規則：
- **只允許數字**：不允許包含任何非數字字符（如空格、橫線等）
- **長度限制**：必須為10碼
- **開頭限制**：必須以09開頭

#### 實現方式：
- 前端輸入限制：添加了 `maxlength="10"` 屬性
- 實時校驗：添加了 `@input="validateMobileInput"` 事件，自動過濾非數字字符
- 提交前校驗：在 `validateForm()` 方法中進行完整校驗

#### 錯誤提示：
- "手機號只能包含數字"
- "手機號長度必須為10碼"
- "手機號必須以09開頭"

### 2. 收件人姓名校驗
收件人姓名必須符合以下規則：
- **字元限制**：4~10個字元
  - 半形英文：可支援4~10個字
  - 中文（含繁體中文）：可支援2~5個字
  - 混合使用：中文按2個字元計算，英文按1個字元計算

#### 實現方式：
- 前端輸入限制：添加了 `maxlength="10"` 屬性
- 字元計算：使用 Unicode 範圍判斷中文字符（包含繁體中文、擴展字符）
- 提交前校驗：在 `validateForm()` 方法中計算字元總長度

#### 錯誤提示：
- "收件人姓名不能為空"
- "收件人姓名字元限制為4~10個字元（中文2~5個字，英文4~10個字）"

## 用戶界面改進

### 1. 輸入框提示
在兩種配送方式的表單中，為輸入框添加了輔助說明文字：

**收件人姓名：**
```html
<div class="form-text">字元限制為4~10個字元（中文2~5個字，英文4~10個字）</div>
```

**手機號：**
```html
<div class="form-text">必須為10碼數字，以09開頭</div>
```

### 2. Placeholder 優化
手機號輸入框的 placeholder 更新為：
- "請輸入收件人手機號（09開頭）"
- "請輸入取貨人手機號（09開頭）"

## 技術實現細節

### 前端實現

#### 1. validateMobileInput 方法
```javascript
validateMobileInput(event) {
    // 移除非數字字符
    this.formData.receiverMobile = this.formData.receiverMobile.replace(/\D/g, '');
}
```
此方法在用戶輸入時實時觸發，自動過濾掉所有非數字字符，提供更好的用戶體驗。

#### 2. 姓名字元計算邏輯
```javascript
const receiverName = this.formData.receiverName.trim();
let nameLength = 0;
for (let i = 0; i < receiverName.length; i++) {
    const char = receiverName.charAt(i);
    // 判斷是否為中文字符（包含繁體中文）
    if (char.match(/[\u4e00-\u9fa5\u3400-\u4dbf\u{20000}-\u{2a6df}...]/u)) {
        nameLength += 2; // 中文字符算2個字元
    } else {
        nameLength += 1; // 英文或其他字符算1個字元
    }
}
```
使用 Unicode 範圍覆蓋了：
- 基本中文字符（\u4e00-\u9fa5）
- 擴展A區（\u3400-\u4dbf）
- 擴展B-F區及補充區
- 兼容字符等

#### 3. 校驗時機
校驗在以下時機觸發：
1. **實時校驗**：手機號輸入時自動過濾非數字
2. **提交前校驗**：點擊「立即支付」按鈕時執行完整校驗
3. **服務端校驗**：後端 ECPayController 也會進行二次校驗

### 後端實現

#### 1. ECPayController 校驗邏輯
在 `createPayment` 方法中添加了詳細校驗：

```java
// 验证收件人姓名长度（4~10个字元，中文算2个字元）
String receiverName = form.getReceiverName().trim();
int nameLength = calculateStringLength(receiverName);
if (nameLength < 4 || nameLength > 10) {
    return R.fail("收件人姓名字元限制為4~10個字元（中文2~5個字，英文4~10個字）", null);
}

// 验证手机号格式：只允许数字、长度限制10碼、必须以09开头
String receiverMobile = form.getReceiverMobile().trim();
if (!receiverMobile.matches("^\\d+$")) {
    return R.fail("手機號只能包含數字", null);
}
if (receiverMobile.length() != 10) {
    return R.fail("手機號長度必須為10碼", null);
}
if (!receiverMobile.startsWith("09")) {
    return R.fail("手機號必須以09開頭", null);
}
```

#### 2. calculateStringLength 輔助方法
```java
private int calculateStringLength(String str) {
    if (str == null || str.isEmpty()) {
        return 0;
    }
    
    int length = 0;
    for (int i = 0; i < str.length(); i++) {
        char c = str.charAt(i);
        // 判断是否为中文字符（包含繁体中文）
        if ((c >= 0x4e00 && c <= 0x9fa5) || 
            (c >= 0x3400 && c <= 0x4dbf) || 
            (c >= 0xf900 && c <= 0xfaff) || 
            (c >= 0x3300 && c <= 0x33ff)) {
            length += 2; // 中文字符算2个字元
        } else {
            length += 1; // 英文或其他字符算1个字元
        }
    }
    
    return length;
}
```

此方法計算字符串的實際字元長度，支持：
- 基本中文字符（0x4e00-0x9fa5）
- 擴展A區（0x3400-0x4dbf）
- 兼容字符（0xf900-0xfaff）
- CJK兼容字符（0x3300-0x33ff）

## 適用場景
此校驗規則同時適用於：
1. **宅配到府**：收件人姓名和手機號
2. **超商取貨**：取貨人姓名和手機號

兩種配送方式共用相同的校驗邏輯，確保數據一致性。

## 測試建議

### 姓名測試用例：
- ✅ "王小明"（3個中文字，6個字元）
- ✅ "李四"（2個中文字，4個字元）
- ✅ "陳大文"（3個中文字，6個字元）
- ✅ "張三丰李四"（5個中文字，10個字元）
- ✅ "John"（4個英文字，4個字元）
- ✅ "JohnSmith"（9個英文字，9個字元）
- ✅ "張三John"（2個中文+4個英文，8個字元）
- ❌ "王"（1個中文字，2個字元 - 太短）
- ❌ "王小明李四張"（6個中文字，12個字元 - 太長）
- ❌ "Joe"（3個英文字，3個字元 - 太短）

### 手機號測試用例：
- ✅ "0912345678"（正確格式）
- ✅ "0987654321"（正確格式）
- ❌ "1234567890"（不是09開頭）
- ❌ "091234567"（只有9碼）
- ❌ "09123456789"（11碼）
- ❌ "0912-345-678"（包含橫線）
- ❌ "0912 345 678"（包含空格）
- ❌ "091234abc8"（包含字母）

## 後續優化建議
1. 考慮在後端 `CreatePaymentForm` 中添加對應的 Bean Validation 註解
2. 可以考慮添加正則表達式校驗特殊字符
3. 建議記錄校驗失敗的情況用於數據分析
