# 物流查询功能使用说明

## 概述

基于绿界科技物流查询API（[https://developers.ecpay.com.tw/?p=7418](https://developers.ecpay.com.tw/?p=7418)），实现了完整的物流订单查询功能，支持根据商户交易编号或绿界物流单号查询物流信息。

## 功能特性

✅ **多种查询方式**：支持商户交易编号和绿界物流单号查询  
✅ **完整参数支持**：包含所有绿界API要求的参数  
✅ **MD5签名验证**：使用MD5加密生成检查码  
✅ **响应解析**：自动解析绿界API返回的物流信息  
✅ **状态码转换**：提供物流状态代码的中文描述  
✅ **错误处理**：完整的异常处理和日志记录  

## 主要方法

### 1. 根据商户交易编号查询

```java
/**
 * 查询物流订单信息
 * @param merchantTradeNo 商户交易编号
 * @return 物流订单查询结果
 */
public R<Map<String, Object>> queryLogisticsOrder(String merchantTradeNo)
```

### 2. 根据绿界物流单号查询

```java
/**
 * 根据绿界物流单号查询物流信息
 * @param allPayLogisticsId 绿界物流交易编号
 * @return 物流订单查询结果
 */
public R<Map<String, Object>> queryLogisticsOrderByAllPayId(String allPayLogisticsId)
```

### 3. 根据订单号查询（便捷方法）

```java
/**
 * 根据订单号查询物流信息（便捷方法）
 * @param orderNo 订单号
 * @return 物流订单查询结果
 */
public R<Map<String, Object>> queryLogisticsByOrderNo(String orderNo)
```

### 4. 获取物流状态描述

```java
/**
 * 获取物流状态描述
 * @param logisticsStatus 物流状态代码
 * @return 物流状态描述
 */
public String getLogisticsStatusDescription(String logisticsStatus)
```

## 使用示例

### 基本查询示例

```java
@Resource
private LogisticsService logisticsService;

/**
 * 查询物流信息示例
 */
public void queryLogisticsExample() {
    // 方式1：根据商户交易编号查询
    R<Map<String, Object>> result1 = logisticsService.queryLogisticsOrder("TEST20250116001");
    
    // 方式2：根据绿界物流单号查询
    R<Map<String, Object>> result2 = logisticsService.queryLogisticsOrderByAllPayId("1817824");
    
    // 方式3：根据订单号查询（推荐）
    R<Map<String, Object>> result3 = logisticsService.queryLogisticsByOrderNo("20250116001");
    
    if (result3.getCode() == 1) {
        Map<String, Object> logisticsData = result3.getData();
        
        // 获取物流信息
        String logisticsStatus = (String) logisticsData.get("LogisticsStatus");
        String logisticsType = (String) logisticsData.get("LogisticsType");
        String allPayLogisticsId = (String) logisticsData.get("AllPayLogisticsID");
        String merchantTradeNo = (String) logisticsData.get("MerchantTradeNo");
        
        // 获取状态描述
        String statusDescription = logisticsService.getLogisticsStatusDescription(logisticsStatus);
        
        log.info("物流查询成功 - 状态：{}，类型：{}，绿界单号：{}", 
                statusDescription, logisticsType, allPayLogisticsId);
    } else {
        log.error("物流查询失败：{}", result3.getMsg());
    }
}
```

### 完整物流信息处理示例

```java
/**
 * 处理物流查询结果
 */
public void processLogisticsInfo(String orderNo) {
    R<Map<String, Object>> result = logisticsService.queryLogisticsByOrderNo(orderNo);
    
    if (result.getCode() == 1) {
        Map<String, Object> logisticsData = result.getData();
        
        // 基本信息
        String allPayLogisticsId = (String) logisticsData.get("AllPayLogisticsID");
        String merchantTradeNo = (String) logisticsData.get("MerchantTradeNo");
        String logisticsStatus = (String) logisticsData.get("LogisticsStatus");
        String logisticsType = (String) logisticsData.get("LogisticsType");
        String tradeDate = (String) logisticsData.get("TradeDate");
        
        // 商品信息
        String goodsName = (String) logisticsData.get("GoodsName");
        Integer goodsAmount = (Integer) logisticsData.get("GoodsAmount");
        Integer handlingCharge = (Integer) logisticsData.get("HandlingCharge");
        
        // 寄件人信息
        String senderName = (String) logisticsData.get("SenderName");
        String senderPhone = (String) logisticsData.get("SenderPhone");
        String senderCellPhone = (String) logisticsData.get("SenderCellPhone");
        
        // 根据物流类型获取不同的信息
        if ("CVS".equals(logisticsType) || logisticsType.startsWith("CVS_")) {
            // 超商取货
            String cvsPaymentNo = (String) logisticsData.get("CVSPaymentNo");
            String cvsValidationNo = (String) logisticsData.get("CVSValidationNo");
            String shipmentNo = (String) logisticsData.get("ShipmentNo");
            
            log.info("超商取货信息 - 寄货编号：{}，验证码：{}，配送编号：{}", 
                    cvsPaymentNo, cvsValidationNo, shipmentNo);
                    
        } else if ("HOME".equals(logisticsType) || logisticsType.startsWith("HOME_")) {
            // 宅配到府
            String bookingNote = (String) logisticsData.get("BookingNote");
            
            log.info("宅配到府信息 - 托运单号：{}", bookingNote);
        }
        
        // 代收货款信息
        Integer collectionAmount = (Integer) logisticsData.get("CollectionAmount");
        Integer collectionAllocateAmount = (Integer) logisticsData.get("CollectionAllocateAmount");
        String collectionAllocateDate = (String) logisticsData.get("CollectionAllocateDate");
        
        if (collectionAmount != null && collectionAmount > 0) {
            log.info("代收货款信息 - 代收金额：{}，拨款金额：{}，拨款日期：{}", 
                    collectionAmount, collectionAllocateAmount, collectionAllocateDate);
        }
        
        // 获取状态描述
        String statusDescription = logisticsService.getLogisticsStatusDescription(logisticsStatus);
        
        log.info("物流信息汇总 - 订单：{}，状态：{}，类型：{}，绿界单号：{}", 
                merchantTradeNo, statusDescription, logisticsType, allPayLogisticsId);
                
    } else {
        log.error("物流查询失败，订单号：{}，错误：{}", orderNo, result.getMsg());
    }
}
```

## API参数说明

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| MerchantID | String(10) | 是 | 厂商编号 |
| MerchantTradeNo | String(20) | 否* | 厂商交易编号（与AllPayLogisticsID二择一） |
| AllPayLogisticsID | String(20) | 否* | 绿界科技的物流交易编号（与MerchantTradeNo二择一） |
| TimeStamp | Int | 是 | 验证时间（Unix时间戳） |
| PlatformID | String(10) | 否 | 特约合作平台商代号 |
| CheckMacValue | String | 是 | 检查码（MD5加密） |

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| AllPayLogisticsID | String(20) | 绿界科技的物流交易编号 |
| MerchantTradeNo | String(20) | 厂商交易编号 |
| LogisticsStatus | String(8) | 物流状态 |
| LogisticsType | String(20) | 物流方式 |
| TradeDate | String(20) | 订单成立时间 |
| GoodsName | String(200) | 商品名称 |
| GoodsAmount | Int | 商品金额 |
| HandlingCharge | Int | 物流费用 |
| BookingNote | String(50) | 托运单号（宅配） |
| CVSPaymentNo | String(15) | 寄货编号（超商） |
| CVSValidationNo | String(10) | 验证码（7-ELEVEN C2C） |
| ShipmentNo | String(25) | 配送编号（超商B2C） |
| CollectionAmount | Int | 代收金额 |
| CollectionAllocateAmount | Int | 物流代收款项拨款金额 |
| CollectionAllocateDate | String(10) | 物流代收款项拨款日期 |

## 物流状态代码

| 状态码 | 状态描述 | 说明 |
|--------|----------|------|
| 300 | 訂單建立 | 物流订单已建立 |
| 301 | 待收件 | 等待收件 |
| 302 | 已收件 | 已收件 |
| 303 | 配送中 | 正在配送 |
| 304 | 已取件 | 已取件（超商） |
| 305 | 已送達 | 已送达 |
| 306 | 退貨中 | 退货中 |
| 307 | 已退貨 | 已退货 |
| 308 | 配送異常 | 配送异常 |
| 309 | 已取消 | 已取消 |

## API地址

- **测试环境**: `https://logistics-stage.ecpay.com.tw/Helper/QueryLogisticsTradeInfo/V5`
- **正式环境**: `https://logistics.ecpay.com.tw/Helper/QueryLogisticsTradeInfo/V5`

## 注意事项

1. **时间戳验证**：绿界验证时间区间为3分钟内有效
2. **参数二择一**：MerchantTradeNo和AllPayLogisticsID必须二择一填写
3. **MD5签名**：使用MD5加密生成CheckMacValue
4. **响应格式**：绿界API返回格式为`参数=值&参数=值`
5. **空值处理**：响应中的"null"字符串会被转换为null值

## 错误处理

```java
public void handleLogisticsQueryError(String orderNo) {
    R<Map<String, Object>> result = logisticsService.queryLogisticsByOrderNo(orderNo);
    
    if (result.getCode() != 1) {
        String errorMsg = result.getMsg();
        
        if (errorMsg.contains("支付订单不存在")) {
            log.error("订单不存在，请检查订单号：{}", orderNo);
        } else if (errorMsg.contains("API调用失败")) {
            log.error("绿界API调用失败，请检查网络连接和配置");
        } else if (errorMsg.contains("解析响应失败")) {
            log.error("绿界API响应解析失败，请检查API返回格式");
        } else {
            log.error("物流查询失败：{}", errorMsg);
        }
    }
}
```

## 测试建议

1. **单元测试**：为每个查询方法编写单元测试
2. **集成测试**：在测试环境验证API调用
3. **参数验证**：测试各种参数组合
4. **错误处理**：测试各种异常情况
5. **性能测试**：测试API调用的响应时间
